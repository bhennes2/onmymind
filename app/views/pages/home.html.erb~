<% if signed_in? %>
	<section class="well span10 form-inline">
		<%= render :partial => "thought_tweet" %>
	</section>

	<section id="notice_area" class="well span10">
		<h3>Quick thoughts:
			<% @thoughts_recent.each do |thought| %>
				<a id="<%= thought.id %>" class="btn btn-primary quickthought" data-toggle="modal" href="#myModal" ><%= thought.tag %></a>
			<% end %>
		</h3>
	</section>

	<section class="well form-search form-inline span10">

		<%= form_tag root_url, :method => 'get', :html => { :id => "search_form" } do %>
			<h2><%= @title2 %></h2>
			<%= text_field_tag :search, params[:search], :disabled => true, :autocomplete => "off", :class => "input-medium search-query" %>
		        <%= submit_tag "Search", :name => nil, :disabled => true, :id => "submit" %>
			<%= radio_button_tag 'type', "Idea" %><label class="radio">Idea</label>
			<%= radio_button_tag 'type', "Tag" %><label class="radio">Tag</label>
			<%= radio_button_tag 'type', "Date" %><label class="radio">Date</label>
		<% end %>
		<div id="search-results" style="display: none; ">
			<%= render :partial => 'search' %>
		</div>
	</section>
	<section class="span10 well form-inline">
		<h3><%= @title3 %></h3>
		<p> Distance:
			<%= radio_button_tag 'distance', "0.1", :checked => true %><label class="radio">Here</label>
			<%= radio_button_tag 'distance', "1" %><label class="radio">1 mi.</label>
			<%= radio_button_tag 'distance', "5" %><label class="radio">5 mi.</label>
			<%= radio_button_tag 'distance', "10" %><label class="radio">10 mi.</label>
		</p>
		<span id="tags_nearby"></span>
	</section>

	<!-- Render modal -->
	<%= render :partial => 'thought_modal' %>

<% else %>
	<!-- Main hero unit for a primary marketing message or call to action -->
		<div class="hero-unit">
        		<h1>Help me to remember please!</h1>
		        <p>Have you ever had a thought pop into your head and just wanted to capture it in that moment before you stand up and forget what that brilliant idea was?&nbsp;OnMyMind helps you record these ideas and make sense of it all.</p>
		        <p><a class="btn btn-primary btn-large" href="<%= signup_path %>"><i class="icon-pencil icon-white"></i> Sign Up &raquo;</a> - OR -
			<a class="btn btn-success btn-large" href="<%= signin_path %>"><i class="icon-user icon-white"></i> Sign In &raquo;</a></p>
		</div>
<% end %>

<script>

	$('input[name=distance]:radio').click(function(){
		$('#tags_nearby').html('');
		update_nearby($('input[name=distance]:radio:checked').val());
	});
	$('input[name=type]:radio').change(function(){
		$('#search').attr('disabled', false);
		$('#submit').attr('disabled', false);
		if ($('input:radio:checked').val() == "Date"){
			$('#search').datepicker({
				dateFormat: 'yy-dd-mm',
				showAnim: 'fold',
				defaultDate: new Date()
			});
		}
		else{
			$('#search').datepicker("destroy");
		}
	});
	$('#search').keyup(function(){
		$('#search-results').show();
		$.get($('#search_form').attr('action'), { search: $('#search').val(), type: $('input:radio:checked').val() }, null, 'script');
		return false;
	});
	$('#search').change(function(){
		$('#search-results').show();
		$.get($('#search_form').attr('action'), { search: $('#search').val(), type: $('input:radio:checked').val() }, null, 'script');
		return false;
	});

	var radius = 0.1;
	var latitude;
	var longitude;

	function getLocation(position) {

		var tag_coords = [
		<% if !current_user.nil? %>
			<% @thoughts_nearby.each do |thought| %>
				{
					tag: "<%= thought.tag %>",
					lat: "<%= thought.location_content.split(',')[0] %>",
					long: "<%= thought.location_content.split(',')[1] %>"
				}<% if @thoughts_nearby.last != thought %>,<% end %>
			<% end %>
		<% end %>
		];
		var R = 6371; //km
		// Current location
		lat1 = position.coords.latitude * Math.PI/180;
		lon1 = position.coords.longitude * Math.PI/180;
		for (var i=0; i < tag_coords.length; i++){

			// Thought location
			lat2 = tag_coords[i].lat * Math.PI/180;
			lon2 = tag_coords[i].long * Math.PI/180;

			var x = (lon2-lon1) * Math.cos((lat1+lat2)/2);
			var y = (lat2-lat1);
			// in km
			var d = Math.sqrt(x*x + y*y) * R;
			// if within 100m...say it's a nearby tag

			// Reformat tag if there is whitespace
			tag_reformat = tag_coords[i].tag.replace(" ","%20");
			if ( d <= radius * 1.6){
				$('#tags_nearby').append('<a href=/tags?tag='+tag_reformat+'>'+tag_coords[i].tag+'</a> | ');
			}
		}
	};
	// One-shot position request.
    	navigator.geolocation.getCurrentPosition(getLocation);

	function update_nearby(rad){
		radius = rad;
		// One-shot position request.
	    	navigator.geolocation.getCurrentPosition(getLocation);
	};

</script>
